# 数据周报自动化系统 - 实施计划

> **文档版本**: V1.0
> **创建日期**: 2026-01-23
> **项目状态**: 🟡 开发中（约 50% 完成）
> **技术栈**: NestJS + React 18 + TypeORM + SQLite

---

## 📋 执行摘要

本文档基于需求规格说明书（V3.0）与当前代码库实现状态的全面对比分析，识别出**未完成、部分完成和已完成**的功能模块，并制定了结构化的实施计划。

### 核心发现

- **后端完成度**: 约 70%（核心生成逻辑已完成，CRUD API 已实现）
- **前端完成度**: 约 30%（基础架构完成，核心业务组件待开发）
- **关键阻塞**: 前端 UI 组件与需求规格存在偏差，需要重构

---

## 🔍 需求完成度分析

### 1. 后端 API 实现状态

| 需求编号   | API 端点                              | 需求描述     | 实现状态      | 说明                                   |
|--------|-------------------------------------|----------|-----------|--------------------------------------|
| API-01 | `POST /api/generate`                | 生成新周报    | ✅ **已完成** | 支持自动计算周期，并发拉取数据                      |
| API-02 | `GET /api/generate/health`          | 健康检查     | ✅ **已完成** | 验证 Jira、PostgreSQL、SQLite 状态         |
| API-03 | `GET /api/reports`                  | 获取历史周报列表 | ✅ **已完成** | 支持分页查询，按创建时间倒序                       |
| API-04 | `GET /api/reports/:id`              | 获取周报详情   | ✅ **已完成** | 包含 metrics、items、notes 完整数据          |
| API-05 | `DELETE /api/reports/:id`           | 软删除周报    | ✅ **已完成** | 标记 `isDeleted = true`                |
| API-06 | `PATCH /api/items/:id`              | 更新单行条目   | ✅ **已完成** | 支持 DONE/PLAN Tab 的行内编辑               |
| API-07 | `PUT /api/reports/:id/manual-items` | 全量更新自采数据 | ✅ **已完成** | 支持树形结构，临时 ID 映射                      |
| API-08 | `PATCH /api/notes/:reportId`        | 更新会议待办   | ✅ **已完成** | 支持创建和更新                              |
| API-09 | `GET /api/export/:reportId`         | 导出 Excel | ✅ **已完成** | 生成 5 个 Sheet（概览、DONE、SELF、PLAN、会议待办） |

**后端结论**: 所有核心 API 已实现，功能完整度 **100%**。

---

### 2. 前端页面与组件实现状态

| 需求编号      | 功能模块           | 需求描述               | 实现状态        | 偏差说明                                                  |
|-----------|----------------|--------------------|-------------|-------------------------------------------------------|
| **UI-01** | **全局导航**       |                    |             |                                                       |
| UI-01-1   | 版本选择器          | 下拉菜单展示历史版本         | ✅ **已完成**   | 支持切换与删除                                               |
| UI-01-2   | 操作栏            | 生成、导出、待办按钮         | ✅ **已完成**   | 功能齐全                                                  |
| **UI-02** | **指标看板**       |                    |             |                                                       |
| UI-02-1   | 栅格布局           | `12:6:6` 比例        | ⚠️ **偏差**   | 当前为 `8:8:8` 等宽布局                                      |
| UI-02-2   | 业务量卡片          | 双色堆叠进度条            | ⚠️ **偏差**   | 使用了两条独立进度条，未调用 `StackedProgress` 组件                   |
| UI-02-3   | ETL 状态卡片       | Loading/Success 状态 | ✅ **已完成**   | 状态展示正常                                                |
| **UI-03** | **周报编辑器**      |                    |             |                                                       |
| UI-03-1   | Tab 切换         | DONE/SELF/PLAN     | ✅ **已完成**   | 切换逻辑正常                                                |
| UI-03-2   | Tab 1 & 3 (列表) | 行内编辑 + 新增空行        | ⚠️ **部分完成** | 逻辑写死在 `TabEditor` 中，未复用 `ReportTable`，**缺失"新增空行"功能**  |
| UI-03-3   | Tab 2 (树表)     | 树形编辑 + 新增主/子任务     | ⚠️ **部分完成** | 逻辑写死在 `TabEditor` 中，未复用 `TreeTable`，**缺失"新增主/子任务"按钮** |
| UI-03-4   | 行内编辑体验         | 双击编辑/失焦保存          | ⚠️ **体验一般** | 当前为"输入框常显"模式，视觉杂乱                                     |
| **UI-04** | **会议待办**       |                    |             |                                                       |
| UI-04-1   | 侧边栏            | 抽屉式编辑器             | ✅ **已完成**   | 支持防抖保存、状态提示                                           |

**前端结论**: 基础架构完成，但核心业务组件存在**设计偏差**和**功能缺失**，需要重构。

---

### 3. 数据库设计完成度

| 需求编号  | 数据表              | 需求描述  | 实现状态      | 说明                           |
|-------|------------------|-------|-----------|------------------------------|
| DB-01 | `reports`        | 报告主表  | ✅ **已完成** | 包含所有必需字段                     |
| DB-02 | `system_metrics` | 系统指标表 | ✅ **已完成** | 支持 5 种指标类型                   |
| DB-03 | `report_items`   | 报表条目表 | ✅ **已完成** | 支持树形结构（`parentId`）           |
| DB-04 | `meeting_notes`  | 会议待办表 | ✅ **已完成** | 纯文本存储                        |
| DB-05 | Migration        | 数据库迁移 | ✅ **已完成** | `InitDatabase` Migration 已执行 |
| DB-06 | 索引优化             | 复合索引  | ✅ **已完成** | 已创建性能索引                      |

**数据库结论**: 设计完整，符合需求规格，完成度 **100%**。

---

### 4. 外部数据源集成状态

| 需求编号  | 数据源        | 需求描述       | 实现状态      | 说明                          |
|-------|------------|------------|-----------|-----------------------------|
| DS-01 | Jira API   | 拉取任务数据     | ✅ **已完成** | `JiraAdapter` 已实现，支持 JQL 查询 |
| DS-02 | PostgreSQL | 拉取 ETL 指标  | ✅ **已完成** | `SqlAdapter` 已实现，支持多数据库连接   |
| DS-03 | 配置管理       | 外部 YAML 配置 | ✅ **已完成** | Zod 校验，支持多环境                |

**数据源结论**: 集成完整，适配器模式设计优秀，完成度 **100%**。

---

### 5. Excel 导出功能状态

| 需求编号  | 功能点            | 需求描述                     | 实现状态       | 说明                                  |
|-------|----------------|--------------------------|------------|-------------------------------------|
| EX-01 | Sheet 1 - 概览   | 周报元数据 + 指标               | ✅ **已完成**  | 包含标题、周期、指标数据                        |
| EX-02 | Sheet 2 - 本周完成 | DONE Tab 数据              | ✅ **已完成**  | 9 列表格，带边框样式                         |
| EX-03 | Sheet 3 - 自采数据 | SELF Tab 树形数据            | ✅ **已完成**  | 支持主任务加粗、子任务缩进                       |
| EX-04 | Sheet 4 - 后续计划 | PLAN Tab 数据              | ✅ **已完成**  | 5 列表格                               |
| EX-05 | Sheet 5 - 会议待办 | 纯文本内容                    | ✅ **已完成**  | 按行分割展示                              |
| EX-06 | 文件命名           | `数据周报_YYYYMMDD_第N周.xlsx` | ⚠️ **待优化** | 当前为 `weekly-report-{reportId}.xlsx` |

**Excel 结论**: 核心功能已实现，文件命名需优化，完成度 **95%**。

---

## 🚀 实施计划

### Phase 1: 前端 UI 修正（优先级 P0）

**目标**: 修正与 UI 设计规格不一致的核心布局，确保视觉规范符合需求。

#### 任务清单

| 任务编号  | 任务描述                          | 预计工时 | 依赖关系  | 负责模块                  |
|-------|-------------------------------|------|-------|-----------------------|
| P1-01 | 修正 Dashboard 栅格布局为 `12:6:6`   | 0.5h | 无     | `MetricDashboard.tsx` |
| P1-02 | 集成 `StackedProgress` 组件替换双进度条 | 1h   | P1-01 | `MetricDashboard.tsx` |
| P1-03 | 验证指标卡片数据对接正确性                 | 0.5h | P1-02 | 前端测试                  |

**验收标准**:

- ✅ 业务量卡片占 50% 宽度，ETL 卡片各占 25%
- ✅ 使用单条双色堆叠进度条展示加工/补录比例
- ✅ Hover 进度条显示 Tooltip（"加工: N (X%) | 补录: M (Y%)"）

---

### Phase 2: 编辑器重构（优先级 P1）

**目标**: 复用已有的业务组件，解决功能缺失，统一交互体验。

#### 任务清单

| 任务编号  | 任务描述                               | 预计工时 | 依赖关系  | 负责模块              |
|-------|------------------------------------|------|-------|-------------------|
| P2-01 | 重构 Tab 1 & 3，引用 `ReportTable` 组件   | 2h   | 无     | `TabEditor.tsx`   |
| P2-02 | 在 `ReportTable` 中实现"新增一行"功能        | 1.5h | P2-01 | `ReportTable.tsx` |
| P2-03 | 优化 `ReportTable` 编辑模式为"双击编辑/失焦保存"  | 2h   | P2-02 | `ReportTable.tsx` |
| P2-04 | 重构 Tab 2，引用 `TreeTable` 组件         | 2h   | 无     | `TabEditor.tsx`   |
| P2-05 | 在 `TreeTable` 中实现"添加主任务"和"添加子任务"按钮 | 2h   | P2-04 | `TreeTable.tsx`   |
| P2-06 | 确保 `TreeTable` 与后端 API 的全量提交对接正常   | 1h   | P2-05 | 前端测试              |

**验收标准**:

- ✅ `TabEditor` 不再包含内部 Table/Tree 逻辑，完全复用业务组件
- ✅ DONE/PLAN Tab 支持"新增空行"功能
- ✅ SELF Tab 支持"添加主任务"和"添加子任务"功能
- ✅ 行内编辑体验优化为"点击变编辑"模式

---

### Phase 3: 交互优化（优先级 P2）

**目标**: 提升细节体验，增强用户操作反馈。

#### 任务清单

| 任务编号  | 任务描述                               | 预计工时 | 依赖关系       | 负责模块                  |
|-------|------------------------------------|------|------------|-----------------------|
| P3-01 | 在 `ReportTable` 保存时增加行级 Loading 效果 | 1h   | Phase 2 完成 | `ReportTable.tsx`     |
| P3-02 | 在 `TreeTable` 中为主任务行添加浅色背景         | 0.5h | Phase 2 完成 | `TreeTable.tsx`       |
| P3-03 | 添加空状态引导（Empty 组件 + "新增记录"按钮）       | 1h   | Phase 2 完成 | 各 Tab 组件              |
| P3-04 | 优化 Excel 导出文件命名为规范格式               | 0.5h | 无          | `ExportController.ts` |

**验收标准**:

- ✅ 保存操作有明确的 Loading 反馈
- ✅ 树形表格层级视觉清晰
- ✅ 空状态有友好的引导提示
- ✅ Excel 文件名符合需求规格（`数据周报_YYYYMMDD_第N周.xlsx`）

---

### Phase 4: 测试与质量保障（优先级 P2）

**目标**: 建立测试体系，确保代码质量和功能稳定性。

#### 任务清单

| 任务编号  | 任务描述                                                       | 预计工时 | 依赖关系         | 负责模块   |
|-------|------------------------------------------------------------|------|--------------|--------|
| P4-01 | 编写后端单元测试（IdService、Adapters、GenerateService）               | 4h   | 无            | 后端测试   |
| P4-02 | 编写前端组件测试（MetricCard、StackedProgress、ReportTable、TreeTable） | 4h   | Phase 2 完成   | 前端测试   |
| P4-03 | 编写集成测试（完整周报生成流程）                                           | 3h   | P4-01, P4-02 | 集成测试   |
| P4-04 | 编写 E2E 测试（编辑与保存流程、Excel 导出验证）                              | 3h   | P4-03        | E2E 测试 |

**验收标准**:

- ✅ 后端单元测试覆盖率 > 70%
- ✅ 前端组件测试覆盖核心业务组件
- ✅ 集成测试验证完整数据流
- ✅ E2E 测试覆盖关键用户路径

---

### Phase 5: 性能优化与用户体验提升（优先级 P3）

**目标**: 优化性能瓶颈，提升用户体验。

#### 任务清单

| 任务编号  | 任务描述                              | 预计工时 | 依赖关系       | 负责模块              |
|-------|-----------------------------------|------|------------|-------------------|
| P5-01 | 实现路由懒加载（React.lazy + Suspense）    | 1h   | 无          | `App.tsx`         |
| P5-02 | 为大表格实现虚拟滚动（`rc-virtual-list`）     | 2h   | Phase 2 完成 | `ReportTable.tsx` |
| P5-03 | 添加骨架屏（Skeleton）替代 Loading Spinner | 1.5h | 无          | 各页面组件             |

**验收标准**:

- ✅ 首屏加载时间 < 2 秒
- ✅ 大表格（>100 行）滚动流畅
- ✅ 加载状态有友好的骨架屏

---

### Phase 6: 生产部署准备（优先级 P3）

**目标**: 完成生产环境部署准备，确保系统可上线。

#### 任务清单

| 任务编号  | 任务描述                | 预计工时 | 依赖关系 | 负责模块   |
|-------|---------------------|------|------|--------|
| P6-01 | Docker 容器化（前后端分离镜像） | 3h   | 无    | DevOps |

**验收标准**:

- ✅ Docker 镜像构建成功，可一键部署

---

## ⚠️ 风险与依赖

### 技术风险

| 风险编号 | 风险描述                        | 影响等级 | 缓解措施                               |
|------|-----------------------------|------|------------------------------------|
| R-01 | 前端组件逻辑重复，维护成本高              | 🔴 高 | **Phase 2 必须完成重构**，否则后续 bug 修复成本翻倍 |
| R-02 | Jira API 限制 1000 条，大数据量场景失效 | 🟡 中 | Phase 5 实现分页查询，或与 Jira 管理员协商提高限额   |
| R-03 | SQLite WAL 模式写写互斥，高并发场景性能瓶颈 | 🟡 中 | 监控并发写入情况，必要时迁移到 PostgreSQL         |
| R-04 | 前端大表格渲染性能问题（>500 行）         | 🟡 中 | Phase 5 实现虚拟滚动                     |

### 依赖关系

| 依赖编号 | 依赖描述                                                 | 阻塞任务         | 解决方案                                           |
|------|------------------------------------------------------|--------------|------------------------------------------------|
| D-01 | 后端 API `PUT /api/reports/:id/manual-items` 必须支持全量树结构 | P2-06        | **已验证**：`ReportsService.updateManualItems` 已实现 |
| D-02 | React Query 缓存更新机制必须正常                               | P2-03, P2-06 | 使用 `invalidateQueries` 确保数据一致性                 |
| D-03 | Jira 和 PostgreSQL 凭证必须有效                             | 所有数据拉取功能     | 配置文件中填入有效凭证，健康检查验证                             |

---

## 📊 工时估算

| 阶段                | 任务数    | 预计工时    | 优先级 | 建议开始时间         |
|-------------------|--------|---------|-----|----------------|
| Phase 1: 前端 UI 修正 | 3      | 2h      | P0  | 立即开始           |
| Phase 2: 编辑器重构    | 6      | 10.5h   | P1  | Phase 1 完成后    |
| Phase 3: 交互优化     | 4      | 3h      | P2  | Phase 2 完成后    |
| Phase 4: 测试与质量保障  | 4      | 14h     | P2  | 与 Phase 2/3 并行 |
| Phase 5: 性能优化     | 5      | 10.5h   | P3  | Phase 2 完成后    |
| Phase 6: 生产部署准备   | 4      | 12h     | P3  | 所有功能完成后        |
| **总计**            | **26** | **52h** | -   | -              |

**建议排期**:

- **Sprint 1（1 周）**: Phase 1 + Phase 2（核心功能修正）
- **Sprint 2（1 周）**: Phase 3 + Phase 4（交互优化 + 测试）
- **Sprint 3（1 周）**: Phase 5 + Phase 6（性能优化 + 部署准备）

---

## ✅ 验收标准

### 功能验收

- [ ] 所有 API 端点正常响应，无 500 错误
- [ ] 前端页面布局符合 UI 设计规格（栅格比例、进度条样式）
- [ ] 周报生成流程完整（生成 → 编辑 → 保存 → 导出）
- [ ] 历史版本切换无数据丢失
- [ ] Excel 导出文件格式正确，树形结构缩进清晰

### 性能验收

- [ ] 周报生成时间 < 5 秒（Jira + PostgreSQL 并发拉取）
- [ ] 前端首屏加载时间 < 2 秒
- [ ] 大表格（>100 行）滚动流畅，无卡顿
- [ ] Excel 导出时间 < 3 秒

### 质量验收

- [ ] 后端单元测试覆盖率 > 70%
- [ ] 前端组件测试覆盖核心业务组件
- [ ] 集成测试通过率 100%
- [ ] E2E 测试覆盖关键用户路径

---

## 📚 参考文档

- [需求规格说明书](../数据周报自动化系统%20-%20需求规格说明书.md)
- [根级 CLAUDE.md](../CLAUDE.md)
- [后端模块文档](../backend/CLAUDE.md)
- [前端模块文档](../frontend/CLAUDE.md)

---

## 📝 变更记录

| 日期         | 版本   | 变更内容               | 变更人 |
|------------|------|--------------------|-----|
| 2026-01-23 | V1.0 | 初始版本，完成需求对比分析与实施计划 | 哈雷酱 |