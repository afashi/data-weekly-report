# 数据周报自动化系统 - 需求规格说明书

#  

| **项目属性** | **内容**                        |
|----------|-------------------------------|
| **文档版本** | **V3.0**                      |
| **项目代号** | `Weekly_Report`               |
| **用户角色** | 数据部门负责人                       |
| **技术栈**  | **前端:** React 18 + Ant Design 

**后端:** NestJS + TypeORM

**数据库:** SQLite |

## 1. 项目概述

### 1.1 核心目标

构建一套自动化数据周报管理系统，解决手工统计耗时、口径不统一及历史追溯难的问题。系统需实现多源数据（Jira、数据库、人工）的自动化聚合，提供快照式的版本管理与编辑功能，并支持一键导出标准格式
Excel 周报。

### 1.2 核心业务流程

1. **配置加载**：系统启动时读取外部配置文件（Jira 凭证、数据库连接等）。
2. **快照生成**：通过触发机制并发拉取 Jira 任务与数据库指标，计算本周时间周期，生成独立的周报版本快照并落库。
3. **交互编辑**：用户在 Web 界面对自动抓取的数据进行修订，并维护层级化的自采数据与会议待办。
4. **导出交付**：基于当前快照数据，渲染生成符合部门规范的 Excel 报表。

## 2. 系统设计规范

### 2.1 数据库设计规范

- **命名风格**：所有数据库表名、字段名强制使用 **下划线命名法 (snake_case)**。
- **主键策略**：所有表的主键 (`id`) 必须为 **BIGINT (Long)** 类型。
- **ID 生成**：主键值必须由应用层（后端）通过 **雪花算法 (Snowflake)** 生成，确保全局唯一且有序。

### 2.2 数据交互规范

- **ID 传输**：鉴于前端 JavaScript 对 64 位整数的精度限制，所有涉及 `BIGINT` 类型的 ID 在 API 传输层必须序列化为 **String
  ** 类型。
- **版本管理**：系统采用“快照模式”，每次生成的周报数据独立存储，修改不影响历史版本，且不回写源系统（Jira）。

## 3. 数据模型设计

### 3.1 报告主表 (`reports`)

用于存储每次生成的周报版本元数据。

| **字段名**       | **类型**     | **说明**                                |
|---------------|------------|---------------------------------------|
| `id`          | **BIGINT** | 主键                                    |
| `week_range`  | VARCHAR    | 周周期描述 (e.g., "2026/01/12-2026/01/18") |
| `week_number` | INT        | 年度周数 (e.g., 3)                        |
| `created_at`  | DATETIME   | 生成时间                                  |
| `is_deleted`  | BOOLEAN    | 软删除标记                                 |

### 3.2 顶部指标表 (`system_metrics`)

存储页面顶部的关键统计指标。

| **字段名**        | **类型**     | **说明**                             |
|----------------|------------|------------------------------------|
| `id`           | **BIGINT** | 主键                                 |
| `report_id`    | **BIGINT** | 关联报告 ID                            |
| `metric_key`   | VARCHAR    | 指标标识（补录单数、加工单数、总数、验证环境ETL、复盘环境ETL） |
| `metric_value` | VARCHAR    | 显示值（数值或时间字符串）                      |
| `status_code`  | VARCHAR    | 状态标识（loading, success, normal）     |

### 3.3 报表条目表 (`report_items`)

存储三个核心 Tab 页的详细数据行，支持树形结构。

| **字段名**        | **类型**     | **说明**                                         |
|----------------|------------|------------------------------------------------|
| `id`           | **BIGINT** | 主键                                             |
| `report_id`    | **BIGINT** | 关联报告 ID                                        |
| `tab_type`     | VARCHAR    | 标签类型：`DONE` (本周完成), `SELF` (自采), `PLAN` (后续计划) |
| `source_type`  | VARCHAR    | 数据来源：`JIRA`, `SQL`, `MANUAL`                   |
| `parent_id`    | **BIGINT** | 父节点 ID（用于自采数据的任务层级，根节点为 NULL）                  |
| `content_json` | TEXT       | 业务数据 JSON（包含任务名、Jira号、工期、各环境状态、负责人等）           |
| `sort_order`   | INT        | 排序权重                                           |

### 3.4 会议待办表 (`meeting_notes`)

存储非结构化的备忘录信息。

| **字段名**     | **类型**     | **说明**  |
|-------------|------------|---------|
| `id`        | **BIGINT** | 主键      |
| `report_id` | **BIGINT** | 关联报告 ID |
| `content`   | TEXT       | 纯文本内容   |

## 4. 功能需求规格

### 4.1 全局导航与版本管理

- **历史版本切换器**：
    - 页面左上角需提供下拉菜单，展示所有历史周报版本。
    - 列表项格式：`时间范围 (第N周) - 生成时间`。
    - 支持删除特定历史版本（软删除）。
    - 切换版本时，全页面数据无刷新重载。
- **全局操作栏**：
    - **生成本周周报**：触发后端生成逻辑，成功后自动跳转至新版本。
    - **导出 Excel**：下载当前选中版本的 Excel 文件。
    - **待办事项**：控制侧边栏/抽屉的展开与收起。

### 4.2 核心指标看板 (Dashboard)

页面顶部需并列展示以下 3 个关键指标卡片：

页面顶部采用 **Grid 栅格布局**，分为三个主要卡片区域。

**布局比例建议**：`12 : 6 : 6` (在 24 栅格系统中)，即业务量卡片占 50% 宽度，两个环境卡片各占 25%。

#### 卡片 1：本周业务量概览 (Business Volume)

- **展示逻辑**：总览数字 + 构成比例可视化。

- **UI 结构**：

    1. **顶部 - 总数 (Total)**：

        - 居中或左上对齐显示大号数字 **“本周总数量”**。

        - 数据来源：`system_metrics.TOTAL_COUNT` (后端计算)。

    2. **中部 - 比例条 (Ratio Line)**：

        - 使用 **双色堆叠进度条 (Stacked Progress Bar)** 横向展示。

        - **左段 (Color A)**：代表加工单占比 (`PROCESS_COUNT` / `TOTAL_COUNT`)。

        - **右段 (Color B)**：代表补录单占比 (`MANUAL_COUNT` / `TOTAL_COUNT`)。

        - _交互细节_：鼠标 Hover 进度条时，显示 Tooltip "加工: N (X%) | 补录: M (Y%)"。

    3. **底部 - 分类数值 (Breakdown Labels)**：

        - 在进度条下方两端分别标注具体数值。

        - **左侧对齐**：`● 加工单：N` (颜色对应进度条左段)。

        - **右侧对齐**：`● 补录单：M` (颜色对应进度条右段)。
- **数据来源**：对应 `system_metrics` 表中的 `TOTAL_COUNT`, `PROCESS_COUNT`, `MANUAL_COUNT`。

#### 卡片 2：验证环境加载 (Verify ETL)

- **内容**：显示加载开始时间。

- **状态指示**：仅支持两种状态。

    - `Loading`：显示加载图标/Spinner。

    - `Success`：显示绿色对勾或“已完成”字样。

#### 卡片 3：复盘环境加载 (Review ETL)

- **内容**：显示加载开始时间。

- **状态指示**：同上（仅 Loading / Success）。

### 4.3 周报编辑器 (Tab Editor)

系统需包含三个主要标签页，分别对应不同的数据视图与交互逻辑。

### Tab 1: 本周完成 (Weekly Done) & Tab 3: 后续计划 (Future Plan)

- **展示形式**：标准二维表格。
- **数据来源**：Jira 自动抓取数据 + 人工手动新增数据。
- **列定义**：维度、相关Jira、任务名称、状态/进度、生产环境状态、验证环境状态、复盘环境状态、预计工期、完成时间、负责人、备注。
- **交互要求**：
    - 修改保存：最后一列为编辑和删除按钮。
    - 支持新增空行：用于录入非 Jira 事项。

### Tab 2: 自采数据 (Self-Collected)

- **展示形式**：**树形表格**。
- **数据结构**：
    - **Level 1 (主任务)**：展示任务概览（名称、Jira号、整体状态）。
    - **Level 2 (子任务)**：归属于主任务，展示执行细节（步骤名、工期、负责人、完成情况）。
- **交互要求**：
    - **新增主任务**：在表格底部添加根节点。
    - **新增子任务**：在主任务行操作区添加子节点。
    - **数据保存**：采用全量树结构提交模式，确保层级关系的一致性。

### 4.4 会议待办 (Meeting Notes)

- 提供一个纯文本编辑区域（抽屉或独立面板）。
- 内容需关联当前周报 ID，随版本切换而变化。
- 支持自动保存或快捷键保存。

## 5. 接口与逻辑定义

### 5.1 核心 API 资源

| **动词**   | **路径**                          | **功能描述**                   |
|----------|---------------------------------|----------------------------|
| `GET`    | `/api/reports`                  | 获取历史周报版本列表                 |
| `POST`   | `/api/reports/generate`         | 触发 ETL 流程生成新周报             |
| `GET`    | `/api/reports/:id`              | 获取指定周报的完整详情（含指标、条目树、待办）    |
| `PUT`    | `/api/reports/:id/manual-items` | 全量更新自采数据 Tab（接收 Tree JSON） |
| `PATCH`  | `/api/items/:id`                | 更新单行条目内容（用于 Tab 1 & 3）     |
| `PATCH`  | `/api/notes/:report_id`         | 更新会议待办内容                   |
| `GET`    | `/api/reports/:id/export`       | 导出 Excel 文件流               |
| `DELETE` | `/api/reports/:id`              | 软删除指定周报                    |

### 5.2 生成逻辑 (Generate Logic)

1. **ID 生成**：调用工具类生成 Snowflake ID。
2. **时间计算**：基于服务器当前时间，计算本周起始日期（周一至周日）及年度周数。
3. **数据获取**：
    - 查询数据库 ETL 日志表获取环境加载时间与状态。
    - 通过 JQL 查询 Jira 获取符合条件的 Issue 列表。
4. **数据转换**：将 Jira Issue 字段映射为系统内部 JSON 结构。
5. **事务落库**：原子性地写入主表、指标表、条目表及初始化待办表。

## 6. 导出交付规格

### 6.1 Excel 格式要求

导出文件需严格遵循以下 Sheet 结构与样式：

1. **Sheet 1 - 本周完成**：对应 Tab 1 数据。
2. **Sheet 2 - 自采数据**：对应 Tab 2 数据。
    - **层级表现**：
        - **主任务**：整行背景色加深，字体加粗。
        - **子任务**：位于主任务下方，“任务名称”单元格需有缩进（建议缩进 2-4 字符）以体现层级。
3. **Sheet** 3 **- 后续计划**：对应 Tab 3 数据。
4. **Sheet 4 - 维度说明**：静态图例说明。

### 6.2 文件命名

文件名格式：`数据周报_YYYYMMDD_第N周.xlsx`（日期为生成日期）。